<!DOCTYPE html>
<html>
<head>
<!----------------------------------------------------------
 
	Copyright (c) 2017-2018 Jean-Marc VIGLINO, 
	released under CeCILL-B (french BSD like) licence: http://www.cecill.info/
	
------------------------------------------------------------>
	<title>ol-ext: Geolocation draw</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<meta name="description" content="an OL3 interaction to draw using the GPS of your device." />
	<meta name="keywords" content="ol3, interaction, draw, GPS, location, geolocation" />

	<link rel="icon" type="image/png" href="https://openlayers.org/assets/theme/img/logo70.png" />

	<!-- android -->
	<meta name="mobile-web-app-capable" content="yes">
	<!-- iOS -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="translucent-black">
	<link rel="apple-touch-icon" href="https://openlayers.org/assets/theme/img/logo70.png" />
	<link rel="apple-touch-startup-image" href="https://openlayers.org/assets/theme/img/logo70.png" />

	<meta name="format-detection" content="telephone=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
	<!meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1" />

	<!-- Geolocation only works on https -->
	<script>
		if (location.protocol == 'http:')
		{	location.href = window.location.href.replace(/^http:/,"https:");
		}
	</script>

	<!-- FontAwesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<!-- jQuery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>

	<!-- Openlayers -->
    <link rel="stylesheet" href="https://openlayers.org/en/latest/css/ol.css" />
	<script type="text/javascript" src="https://openlayers.org/en/latest/build/ol.js"></script>
	<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL,Object.assign"></script>
	
	<!-- ol-ext -->
    <link rel="stylesheet" href="dist/ol-ext.css" />
	<script type="text/javascript" src="dist/ol-ext.js"></script>

	<link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="map.switcher2.css" />


	<style>
		#map
		{	position: fixed;
			top:0em;
			left:0;
			right:0;
			bottom:0;
			width:auto;
			height: auto;
			margin: 0;
		}
.ol-custom-mouse-positionHDMS {
  top: auto;
  bottom: 5em;
  font-family: "Arial";
  font-size: 12px;
  text-shadow: 0 0 0.5em #FFE, 0 0 0.5em #FFE, 0 0 0.5em #FFE;
  background-color: rgba(0,60,136,.5); 
}
.ol-fullscreen {
  left: 0.5em;
  top: 8.5em;
}
.ol-custom-overviewmap,
.ol-custom-overviewmap.ol-uncollapsible {
  bottom: auto;
  left: 0;
  right: auto;
  top: 230px;
}  
		.ol-search ul {
			color: #333;
			font-size:0.85em;
			max-width: 21em;
		}
		.ol-search ul i {
			display: block;
			color: #333;
			font-size:0.85em;
		}
.ol-control {
    position: absolute;
    border-radius: 1px;
    padding: 2px;
}
.ol-control button {
    display: block;
    margin: 1px;
    padding: 0;
    color: #fff;
    font-size: 1.3em;
    font-weight: 700;
    text-decoration: none;
    text-align: center;
    line-height: .4em;
    background-color: #017eff;
    border: none;
    border-radius: 2px
}
		.ol-overlay.menu
		{	width: 220px;
			background: #fff;
			color: #333;
			box-shadow: 0px 0px 5px #000;
			padding: 0.5em;
			-webkit-transition: all 0.25s;
			transition: all 0.25s;
		}
		/* style the close box */
		.ol-overlay.menu .ol-closebox
		{	color: #369;
			left: 1em;
			top: 0.5em;
		}
		.ol-overlay.menu .ol-closebox:before
		{	content:"\f0c9";
			font-family:FontAwesome;
		}
		.ol-zoom
		{	top: 3.5em;
			left: 0.5em;
		}
		#menu
		{	padding-top: 1.5em;
			font-size: 0.9em;
		}
		/* menu button */
		.ol-control.menu
		{	top: 0.5em;
			left: 0.5em;
		}
		.ol-control.menu i
		{	color: #fff;
		}
		.ol-overlay img
		{	max-width: 90%;
		}
		.data,
		.data p
		{	margin:0;
			text-align: center;
			font-size:0.9em;
		}
</style>

</head>
<body >
	
	
	<!-- Map div -->
	<div id="map"></div>
	<!-- <div class="options"></div> -->
	<div class="ol-mouse-position"></div>

		<!-- Content of the menu -->
	<div id="menu">
		<h1>Information</h1>
		<div class="options"></div>
	</div>
	
	
	<script type="text/javascript">
  // A group layer for base layers
  var baseLayers = new ol.layer.Group({
    title: 'Base Layers',
    openInLayerSwitcher: false,
    layers: [
	  new ol.layer.Tile({
        title: "Ortofotomapa",
        baseLayer: true,
        visible: false,
        source: new ol.source.TileArcGISRest({
		url: 'https://ags.cuzk.cz/arcgis/rest/services/ortofoto/MapServer'
		})
      }),
	  new ol.layer.Tile({
        title: "Základní mapa",
        baseLayer: true,
        visible: true,
        source: new ol.source.TileArcGISRest({
		url: 'https://ags.cuzk.cz/arcgis/rest/services/zm/MapServer'
		})
      }),
      new ol.layer.Tile({
        title: "OSM",
        baseLayer: true,
        source: new ol.source.OSM(),
        visible: false
      })
    ]
  });
	  
  // An overlay that stay on top
  var labels = new ol.layer.Tile({
    title: "Labels (on top)",
    allwaysOnTop: true,			// Stay on top of layer switcher
    visible: false,		// Prevent deleting from layer switcher
    source: new ol.source.Stamen({ layer: 'terrain-labels' })
  });
      // IG mapa 1 : 50 000
  var url = 'https://mapy.geology.cz/arcgis/rest/services/Geohazardy/IG_rajony50/MapServer';
  var IG50 = new ol.layer.Tile ({
	title: 'IG50',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});
	  // IG mapa 1 : 500 000
  var url = 'https://mapy.geology.cz/arcgis/rest/services/Geohazardy/IG_rajony500/MapServer';
  var IG500 = new ol.layer.Tile ({
	title: 'IG500',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});
      // Geologická mapa 1 : 50 000
  var url = 'https://mapy.geology.cz/arcgis/rest/services/Geologie/GEOCR50_mobil/MapServer';
  var geocr50 = new ol.layer.Tile ({
	title: 'GEO50',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});
    // Geomorfologické jednotky
  var url = 'https://ags.cuzk.cz/arcgis/rest/services/GeomorfologickeJednotky/MapServer';
  var gj = new ol.layer.Tile ({
	title: 'Geomorfologické jednotky',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});
      // kvartér - ČGS
  var url = 'https://mapy.geology.cz/arcgis/rest/services/Geologie/G25_rastr_GK/MapServer';
  var kv = new ol.layer.Tile ({
	title: 'Kvartér - ČGS',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});
      // GEO500
  var url = 'https://mapy.geology.cz/arcgis/rest/services/Geologie/geologicka_mapa500/MapServer';
  var geo500 = new ol.layer.Tile ({
	title: 'GEO500',
    visible: false,
	source: new ol.source.TileArcGISRest({
		url: url
		}),
	});	
	  // Image
  var imageLayer = new ol.layer.Image({
	title: 'GEO500-R',
	Description: '<p>Document Info: <a href="https://mapy.geology.cz/arcgis/rest/services/Geologie/geologicka_mapa500/MapServer" target="_blank" rel="noopener">Click here</a></p>',
	visible: false,
    source: new ol.source.ImageStatic({
		url: 'geo.png',
		imageExtent: ol.extent.applyTransform([1283277.82145052, 6654396.46000354,  2159210.85091522, 6180156.19161868], ol.proj.getTransform("EPSG:3857", "EPSG:3857"))
        })
    });
  
  // The Map
  var map = new ol.Map ({	target: 'map',
    view: new ol.View({
      zoom: 11,
      center: [2034081, 6415818]
    }),
    controls: ol.control.defaults().extend ([
      // Add a new Layerswitcher to the map
      new ol.control.ScaleLine(),
      // new ol.control.OverviewMap({
      // className: 'ol-overviewmap ol-custom-overviewmap'
    // }),
	  new ol.control.FullScreen({
      className: 'ol-fullscreen'
    }),
	  new ol.control.MousePosition({
      coordinateFormat: function(coord) {
        return ol.coordinate.toStringHDMS(coord);
      },
      projection: 'EPSG:4326',
      className: 'ol-mouse-position ol-custom-mouse-positionHDMS',
      target: document.getElementById('mouse-position'),
      undefinedHTML: '&nbsp;'
    }),
	  new ol.control.LayerSwitcher({
		oninfo: function(l){
          $('.options').html(l.get('title')+'<br/>'+l.get('Description'));
        }
      })
    ]),
    layers: [ baseLayers, gj, kv, geocr50, imageLayer, geo500, IG50, IG500, labels ]
  });

  
  
  
  	// Overlay
	var menu = new ol.control.Overlay ({ 
		closeBox : true, 
		className: "slide-left menu", 
		content: $("#menu").get(0)
	});
	map.addControl(menu);

	// A toggle control to show/hide the menu
	var t = new ol.control.Toggle(
			{	html: '<i class="fa fa-bars" ></i>',
				className: "menu",
				title: "Menu",
				onToggle: function() { menu.toggle(); }
			});
	map.addControl(t);

	// Control Select 
	var select = new ol.interaction.Select({});
	map.addInteraction(select);

	// On selected => show/hide popup
	select.getFeatures().on('add', function(e)
	{	var feature = e.element;
		var img = $("<img>").attr("src", feature.get("img"));
		var info = $("<div>").append( $("<p>").text(feature.get("text")));
		var content = $("<div>")
				.append( img )
				.append(info);
		$(".data").html(content);
		
	});
	select.getFeatures().on('remove', function(e)
	{	$(".data").html("");
	});
  
  
  
  
  
  
  
  
		// New vector layer
		var vector = new ol.layer.Vector({
      displayInLayerSwitcher: false,
	  name: 'Vecteur',
      source: new ol.source.Vector()
    });
		map.addLayer(vector);

		var geolocBar = new ol.control.GeolocationBar({
	  source: vector.getSource(),
      zoom: 16,
      minAccuracy:10000
    });
    map.addControl(geolocBar);

	
	// Create layer vector
	var vectorSource = new ol.source.Vector({ wrapX: false });
	var vector = new ol.layer.Vector(
		{	source: vectorSource,
		    displayInLayerSwitcher: false,
		});
	map.addLayer(vector);

	map.on ('moveend', function(e)
	{	var ex = e.frameState.extent;
		var t = new Date()
		var f = vectorSource.getFeaturesInExtent(ex);
		$(".vis span").text(f.length);
		// console.log("Calcul "+(new Date() -t));
	});

	var defaultStyle = 	vector.getStyle();
	var label = $("#label").val();

	function setStyle(f,r)
	{	var s = defaultStyle(f,r);
		var text = f.get(label);
		if (text && r<100000)
		{	text = text.toString();
			s = $.extend ([], s);
			var g = f.getGeometry();
			if (g.getType()=="MultiPolygon")
			{	var p = g.getPolygons();
				var max = 0;
				var n = 0;
				for (var i=0; i<p.length; i++)
				{	var area = p[i].getArea();
					if (area > max)
					{	max = area;
						n = i;
						g = p[i];
					}
				}
			}
			s.push (new ol.style.Style(
				{	text: new ol.style.Text(
					{	text: text,
						font: '12px helvetica,sans-serif',
						fill: new ol.style.Fill(
						{   color: 'red'//'#000'
						}),
						stroke: new ol.style.Stroke(
						{   color: '#fff',
							width: 2
						})
					}),
					geometry: g
				}));
		}
		return s;
	};

	vector.setStyle (setStyle)

	// Create layer image-vector
	/* old version (<4.6)
	var image = new ol.layer.Image(
	{	source: new ol.source.ImageVector(
		{	source: vectorSource,
			style: vector.getStyle(),
			wrapX: true
		})
	});
	*/
	var image = new ol.layer.Vector(
	{	displayInLayerSwitcher: false,
		source: vectorSource,
		renderMode: 'image',
		style: vector.getStyle()
	});
	map.addLayer(image);

	// Event handlers when source is ready
	vectorSource.on('change',function(e)
	{	if (vectorSource.getState() === 'ready') 
		{	$(".nb span").text(vectorSource.getFeatures().length);
		}
	});

	var select = new ol.interaction.Select();
	map.addInteraction(select);
	select.on("select", function(e)
		{	if (e.selected && e.selected[0]) 
			{	var prop = $.extend ({}, e.selected[0].getProperties());
				delete prop.geometry;
				$(".info").html( JSON.stringify(prop,null, " ").replace(/(^\{\n|\n\}$)/g,"").replace(/\n/g, "<br/>") );
				if (prop.idcliche && prop.mission && prop.url)
				{	var url = "https://wxs.ign.fr/yvmoikafaddadzmxvh6sdmjb/iipsrv?FIF=DEMAT.PVA/"+prop.mission+"/"+prop.url+"&WID=2048&CVT=JPEG";
					var app = "https://localhost.ign.fr/exemples/Map-georeferencer/?photo="+encodeURIComponent(url)
							+"&lon=" + prop.lon
							+"&lat=" + prop.lat
							+"&ori=" + prop.orientation
							+"&res=" + prop.res
							+"&w=" + prop.largeur
							+"&h=" + prop.hauteur
							;
					$("<br/>").appendTo($(".info"));
					var a = $("<a>").attr({href:app, target:"new"}).appendTo($(".info"));
					$("<img>").attr('src', url).appendTo(a).width(100);

				}
			}
			else
			{	$(".info").html("");
			}
		})

	var dd = new ol.interaction.DropFile(
	{	formatConstructors: 
		[	ol.format.GPX,
			ol.format.GeoJSON,
			ol.format.IGC,
			ol.format.KML,
			ol.format.TopoJSON
		]
	});
	map.addInteraction (dd);
	var loading = 0;
	
	// Drag and drop
	dd.on ('loadstart', function (e) 
	{	if (!$("#addto").prop('checked') && !loading) vectorSource.clear();
		select.getFeatures().clear();
		$(".info").html("");

		loading++; 
		$(".loading").show();
		$(".loading p").html("LOADING ("+loading+")");
	});
	dd.on ('addfeatures', function(event) 
	{   
		loading--; 
		$(".loading p").html("LOADING ("+loading+")");
		$(".loading span").html(event.features.length);

		setTimeout(function()
		{	vectorSource.addFeatures(event.features);
			
			if (!loading) $(".loading").hide();

			if (!$("#zoomto").prop('checked')) return;
			var vext = map.getView().getProjection().getExtent();
			var extent = vectorSource.getExtent();
			if (extent[0]<vext[0]) extent[0] = vext[0];
			if (extent[1]<vext[1]) extent[1] = vext[1];
			if (extent[2]>vext[2]) extent[2] = vext[2];
			if (extent[3]>vext[3]) extent[3] = vext[3];
			map.getView().fit(extent, map.getSize());
		},500);
    });

	function setLayerVisibility()
	{	vector.setVisible(!$("#imgvector").prop('checked'));
		image.setVisible($("#imgvector").prop('checked'));
	}
	setLayerVisibility();

	function fixStyle(b)
	{	var f = vectorSource.getFeatures();
		var res = map.getView().getResolution();
		vectorSource.clear();
		for (var i=0; i<f.length; i++)
		{	if (b) 
			{	f[i].setStyle(setStyle(f[i], res));
			} 
			else f[i].setStyle();
		}
		vectorSource.addFeatures(f);
	}
	
		// Set the control grid reference
	var search = new ol.control.SearchPhoton(
		{	//target: $(".options").get(0),
			lang:"en",		// Force preferred language
			position: true	// Search, with priority to geo position
		});
	map.addControl (search);

	// Select feature when click on the reference index
	search.on('select', function(e)
		{	// console.log(e);
			map.getView().animate(
			{	center:e.coordinate,
				zoom: Math.max (map.getView().getZoom(),16)
			});
		});
	</script>

</body>
</html>